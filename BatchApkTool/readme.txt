BATCH APKTOOL 3.4.5 by BurSoft

BATCH APKTOOL - это мощная оболочка, объединяющая несколько инструментов для работы с файлами APK.
Позволяет пакетно деодексировать, декомпилировать, изменять ресурсы и smali-код, рекомпилировать, подписывать, выравнивать (zipalign) APK, ZIP, JAR-файлы.
Дополнительно есть возможность подключения плагинов, просмотра исходного Java кода APK, JAR и DEX-файлов, работы с устройством через ADB, и др.

Подготовка к работе:
Убедитесь, что у вас установлена Java (JRE) 7 или выше. Если нужна портативная версия со встроенной Java - используйте standalone-версию Batch ApkTool.
Распакуйте архив. В пути к утилите и в именах обрабатываемых файлов избегайте спецсимволов (восклицательный знак !, амперсанд &, проценты % и др.) и русских букв.

1.   Деодексация:
1.1  Поместите все содержимое папок system/app, system/priv-app и system/framework прошивки в папки _app, _priv-app и _framework утилиты соответственно. Можно слить файлы прямо с устройства, см п.3.5.
1.2  Укажите API level (пункт меню [84]), соответствующий версии android деодексируемой прошивки.
1.3  Выберите версию smali (пункт меню [83]), с помощью которой будете проводить деодексацию. smali-1.4.2 подходит только для API level <= 17.
1.4  Выберите пункт меню [01].
1.5  Деодексированные и выравненные (zipalign) файлы будут находиться в папках _app, _priv-app и _framework. Содержимое этих папок готово для заливки в устройство.
1.6  Чтобы скопировать деодексированные APK или JAR-файлы для дальнейшей обработки, выберите пункт меню [02] или [03]. Файлы будут скопированы в папки _INPUT_APK или _INPUT_JAR соответственно.

2.   Декомпиляция и рекомпиляция:
2.1  Поместите файлы для обработки в папку _INPUT_APK.
2.2  Если вы планируете разбирать системные файлы (то есть имеющие зависимости с фреймворками прошивки), поместите все APK-файлы из папки system/framework этой прошивки в папку _framework утилиты; если планируете разбирать обычные НЕсистемные APK - оставьте папку _framework пустой.
2.3  Выберите пункт меню [1]. В папке _INPUT_APK появятся разобранные приложения.
2.4  Внесите необходимые изменения.
2.5  Если вы разбираете системные файлы, ВЫключите пункт меню [89] - это сохранит оригинальную подпись системных APK. Для НЕсистемных APK, которые планируется устанавливать как обычные приложения, пункт должен быть включен.
2.6  Выберите пункт [3]. Перепакованные, подписанные (если включена соответствующая опция) и выравненные APK будут находиться в папке _OUT_APK.

3.   ADB:
3.1  Позволяет работать с устройством через Android Debug Bridge. На компьютере должен быть установлен драйвер вашего устройства, а на устройстве должна быть включена отладка по USB.
3.2  Пункт [10] - с него следует начинать работу с ADB. Возможно два варианта подключения:
   - 1 = USB - подключение по USB и отображение подключенных устройств.
   - 2 = Wi-Fi - подключение по Wi-Fi. Для работы режима необходим клиент, например, этот https://play.google.com/store/apps/details?id=com.ttxapps.wifiadb С его помощью можно включить режим беспроводной отладки и узнать IP-адрес устройства.
3.3  Пункт [11] - установка APK на устройство. Установка ведется точно так же, как если бы вы устанавливали файл через файловый менеджер на телефоне, поэтому APK должен быть подписан.
3.4  Пункт [12] - запрос прав суперпользователя и перемонтирование папки /system для записи. Для корректной работы этого пункта необходим рут.
3.5  Пункт [13] - копирование файлов из соответствующих папок на телефоне в папки _app, _priv-app и _framework утилиты.
3.6  Пункт [14] - копирование файлов в соответствующие папки на телефоне. Папка /system должна быть смонтирована для записи через пункт [12].
3.7  Пункт [15] - сохранение снимка экрана в папке проекта (требуется android 4.0 или выше).
3.8  Пункт [16] - запись видео с экрана и сохранение его в папку проекта (требуется android 4.4 или выше, макс. длительность - 3 мин).
3.9  Пункт [17] - терминал устройства.
3.10 Пункт [18] - вывод важнейших системных логов (logcat (main, radio, events), dmesg и bugreport) и сохранение их в файл в папке проекта. Логи можно (и нужно) смотреть при циклических перезагрузках и прочих системных сбоях, даже когда само устройство не отзывается.
   - Подпункт [6] предназначен для сохранения таблицы inline-методов прошивки. Это может помочь, если прошивка не деодексируется стандартным методом (только для Android < 5.0).
3.11 Пункт [19] - различные варианты перезагрузки. Как правило можно перезагрузиться, даже когда само устройство не отзывается.
3.12 Пункт [20] - краткая информация о версии android и файловой системе.
3.13 Пункт [21] - корректно завершает работу сервера ADB. Этой командой необходимо завершать работу с ADB, иначе не сработает безопасное извлечение устройства.

4.   Дополнительные возможности:
4.1  Пункты [04], [05], [06] и [07] предназначены для декомпиляции и рекомпиляции APK или JAR файлов при помощи baksmali-smali. Декомпилируется только smali-код.
   - Для этого поместите APК файлы в папку _INPUT_APK (JAR файлы в папку _INPUT_JAR), укажите API level, декомпилируйте, внесите необходимые изменения и рекомпилируйте. Перепакованные, подписанные (если включена соответствующая опция) и выравненные файлы будут находиться в папках _OUT_APK (_OUT_JAR).
4.2  Пункт [4] позволяет подписывать APK, ZIP, JAR файлы. Поместите файлы для подписи в папку _INPUT_APK, подписанные и выравненные файлы будут находиться в папке _OUT_APK.
4.3  Пункт [5] позволяет выравнивать APK-файлы. Поместите файлы для выравнивания в папку _INPUT_APK, выравненные файлы будут находиться в папке _OUT_APK.
4.4  Пункт [6] позволяет просмотреть исходный Java код APK, JAR и DEX файлов при помощи программ jadx или procyon. jadx также позволяет просмотреть ресурсы APK-файлов.
4.5  Пункт [7] позволяет запускать плагины. Если вы хотите создать собственный плагин, см. примеры в папке bin\plugins. На данный момент доступны следующие плагины:
   - Заменить ресурсы без перекомпиляции: позволяет быстро, без перекомпиляции заменить, например, графику или музыку в APK файлах. Поместите APK в папку _INPUT_APK, а файлы для замены в _INPUT_APK\_RES_REPLACE\_имя_апк_\ с охранением иерархии каталогов. Измененные, подписанные (если включена соответствующая опция) и выравненные файлы будут находиться в папке _OUT_APK.
   - Преобразовать Unicode escapes в UTF-8: конвертирует файлы *.smali декомпилированного кода, переводя последовательности типа "\u043f\u0440\u0438\u0432\u0435\u0442\u0029" в человекопонятные "привет)". Очень полезная штука для перевода строк в smali.
   - Выбрать цвета интерфейcа: позволяет настроить цвета основных элементов интерфейса утилиты.
   - Скопировать файлы из папок _OUT_APK и _OUT_JAR обратно в _app, _priv-app и _framework.
     Кроме того, на форуме 4PDA (http://4pda.ru/forum/index.php?showtopic=557858) доступны плагины для клонирования апк, оптимизации размера графических файлов, патчинга защиты по подписи, и т.д.
4.6  Пункты в категории ОБСЛУЖИВАНИЕ позволяют очистить соответствующие папки утилиты.

5.   Еще немного информации:
5.1  Пункт меню [80] позволяет переключаться между проектами. Название проекта соответствует имени папки, в которой будет вестись работа. Название проекта по умолчанию - ".", это соответствует корневой папке утилиты. После создания других проектов, папки и файл настроек проекта "." можно удалить.
5.2  Пункты меню [81] и [82] позволяют выбрать для обработки один файл из папок _INPUT_APK и _INPUT_JAR соответственно. По умолчанию выбраны все файлы "*".
5.3  Если одна версия apktool сообщает об ошибке при декомпиляции или рекомпиляции, попробуйте другую версию (пункт меню [85]). В папку bin можно добавить любую версию apktool и smali, они должны иметь названия apktool_%номер_версии%.jar, smali-%номер_версии%.jar и baksmali-%номер_версии%.jar.
5.4  При включенной опции [86] поврежденные ресурсы (если таковые имеются), которые приводят к ошибкам при декомпиляции вида "Invalid config flags detected. Dropping resources", будут храниться в папках res\*-ERR*. Вы должны будете исправить их вручную перед рекомпиляцией.
5.5  При включенной опции [87] сборка APK при рекомпиляции будет производится в экспертном режиме - за основу для сборки будет взят исходный APK, и в него будут добавляться измененные файлы. Режим может помочь в случае, когда собранное в стандартном режиме приложение не работает (apktool неправильно выставил степень сжатия, приложение чувствительно к рекомпиляции ресурсов, и т.д.). ВНИМАНИЕ: Режим всегда включен для apktool 1.x. Возможно увеличение размера результирующего APK.
5.6  При декомпиляции со включенной опцией [88] в смали-код не будет добавляться отладочная информация (.local, .param, .line, и т.д.). Благодаря этому сравнивать смали-файлы между собой становится удобнее (например, от разных версий одного и того же приложения).
5.7  Пункт меню [90] позволяет выбрать ключ для подписи APK, ZIP, и JAR файлов. Вы можете добавить собственные ключи в папку bin, они должны иметь название %имя ключа%.pk8 и %имя ключа%.x509.pem
5.8  Чтобы по окончании декомпиляции-рекомпиляции автоматически открывался лог работы, установите опцию [91] в режим ДА. Чтобы после каждой операции выводилось предложение открытия лога, используйте режим ВРУЧНУЮ.
5.9  Сменить язык интерфейса утилиты можно, выбрав пункт меню [92]. Если вы хотите добавить перевод на ваш родной язык в дистрибутив утилиты, пишите в тему утилиты на форуме 4PDA: http://4pda.ru/forum/index.php?showtopic=557858
5.10 Изменить размер шрифта в окне утилиты можно, нажав ПКМ на заголовке окна утилиты -> Свойства -> Шрифт.

Выражаю благодарность авторам компонентов, использующихся в BATCH APKTOOL:
- 7-Zip - http://www.7-zip.org/
- Android SDK - http://developer.android.com/sdk/index.html
- apktool - http://ibotpeaches.github.io/Apktool/
- BG - http://consolesoft.com/p/bg/
- cecho - https://github.com/BobPyron/commandline-utilities/tree/master/CEcho
- Colored Logcat - http://adrianvintu.com/blogengine/post/Colored-Logcat-Script-for-Windows.aspx
- dex2jar - https://github.com/pxb1988/dex2jar
- IniFile - http://www.horstmuc.de/wbat32.htm#inifile
- jadx - https://github.com/skylot/jadx
- luyten - https://github.com/deathmarine/Luyten
- nhreplace - http://nhutils.ru/blog/nhreplace/
- NirCmd - http://www.nirsoft.net/utils/nircmd.html
- oat2dex - https://github.com/testwhat/SmaliEx
- smali - https://github.com/JesusFreke/smali
- Swiss File Knife - http://stahlworks.com/dev/swiss-file-knife.html
- UnicodeEscape2UTF8 - http://www.xinotes.net/notes/note/813/
- wintee - https://code.google.com/p/wintee/
- Zip - http://www.info-zip.org/Zip.html
...а также всем тестерам и пользователям.



История изменений:
v3.4.5
- Обновлен apktool (2.1.1), smali (2.1.2_0424), oat2dex (0.87_0426), luyten 0.4.7 (procyon 0.5.32), Java (8u91).
- Изменен метод деодексации Android 6.0.
- В дистрибутив добавлен плагин CopyBack.

v3.4.4
- Обновлен apktool (2.1.0), oat2dex (0.86_0316), Java (8u77).
- Добавлена деодексация Android N.
- Ошибка деодексации boot.oat теперь не прерывает процесс деодексации.

v3.4.3
- Обновлен apktool (2.1.0_0229), oat2dex (0.86_0226), smali (2.1.2_0228), Java (8u73).
- Добавлено копирование папок /system/app, /system/priv-app, /system/framework из устройства в папки утилиты (п. 13 -> 4).
- Исправлена обработка некоторых файлов с нестандартными zip-заголовками (при деодексации и сборке в экспертном режиме).
- Обновлены бинарники adb, zipalign.

v3.4.2
- Обновлен apktool (2.1.0_0106), oat2dex (0.86_0107), smali (2.1.1), luyten 0.4.6 (procyon 0.5.32).
- Ускорена деодексация файлов Android 6.0.
- Исправлена деодексация файлов с несколькими classes.dex (Android 6.0).
- Добавлено копирование файлов из _OUT_APK в /system/framework.
- Добавлен украинский язык (спасибо Volodiimr).

v3.4.1
- Обновлен apktool (2.0.3_1024), smali (2.1.0_1018), oat2dex (0.85_1013), jadx (0.6.1 build 221), Java (8u65).

v3.4.0
- Добавлена деодексация Android 6.0
- Обновлен apktool (2.0.2_0930_), smali (2.1.0_1002), oat2dex (0.83_0930), jadx (0.6.1 build 220).

v3.3.4
- Обновлен apktool (2.0.2_0912_fix), jadx (0.6.1 build 218).

v3.3.3
- Обновлен apktool (2.0.2_0821), smali (2.0.7_0906), oat2dex (0.83_0909), luyten 0.4.4 (procyon 0.5.30), jadx (0.6.1 build 215), Java (8u60).
- Обновлены бинарники adb.
- Исправлено чтение скрытых символьных ссылок.

v3.3.2
- Добавлена деодексация .odex.gz-файлов.
- Исправлена подпись zip-файлов для рекавери.
- Мелкие исправления.
- Обновлен apktool (2.0.2_0811), jadx (0.6.1 build 210), oat2dex (0.83_0806).

v3.3.1
- Добавлена деодексация .apk-файлов в папке _framework.
- Функция копирования файлов в устройство (пункт 14) теперь копирует файлы рекурсивно вместе с подкаталогами.
- Добавлено копирование деодексированных APK и JAR-файлов в папки _INPUT_APK и _INPUT_JAR.
- Обновлен apktool (2.0.1), jadx (0.6.1 build 206), Java (8u51).

v3.3.0
- Добавлены испанский, китайский, немецкий, турецкий и французский языки.
- Изменена логика деодексации файлов: теперь файлы деодексируются непосредственно в папках _app, _priv-app и _framework.
- Улучшены алгоритмы деодексации: теперь деодексируются файлы всех архитектур за один проход.
- В лог деодексации добавлен вывод символьных ссылок (для updater-script).
- Исправлена деодексация файлов с несколькими classes.dex.
- Обновлен apktool (2.0.1_0629), smali (2.0.7_0619), jadx (0.6.1 build 203), oat2dex (0.83).

v3.2.1
- Добавлен беларуский язык
- Логи теперь сохраняются в UTF-8 с BOM
- Увеличен размер Java heap для oat2dex.jar

v3.2.0
- Добавлена поддержка файлов локализаций. В дистрибутив добавлен русский и английский языки.
- Добавлена начальная поддержка плагинов. Функции замены ресурсов без перекомпиляции и преобразования unicode-последовательностей в UTF-8 перенесены в плагины.
- Добавлен плагин настройки цвета основных элементов интерфейса.
- Декомпилятор исходного Java-кода jd-gui заменен на luyten 0.4.4 (procyon 0.5.28).
- Добавлен вывод цветного форматированного текста в logcat. Логи теперь сохраняются в реальном времени во время просмотра.
- Исправлено игнорирование изменений в папке libs.
- Обновлен apktool (2.0.1_0524), smali (2.0.6_0523), jadx (0.6.1 build 198), oat2dex (0.81).
- Различные улучшения и исправления.

v3.0.1
- Добавлен счетчик обрабатываемых файлов.
- Фреймы теперь устанавливаются из папки _framework и всех ее подпапок.
- Обновлен apktool (2.0.0), smali (2.0.5_0410), jadx (0.6.0), jd-gui (1.0.0-RC4), dex2jar (2.0).
- Обновлена Java 8u45 (в standalone-версии BAT).

v3.0
- Улучшен алгоритм работы экспертного режима.
- Добавлена деодексация приложений архитектуры x86 (Android 5.0).
- Добавлено сохранение таблицы inline-методов прошивки (пункт 18->8) (см. readme п. 3.10).
- Увеличена скорость декомпиляции.
- Обновлен apktool (2.0.0-RC4_0322), smali (2.0.5_0321), jadx (0.5.5 build 181), signapk.

v2.9.9
- Исправлена функция рекомпиляции, если в папке C:\Windows присутствует файл aapt.exe
- Обновлен jadx (0.5.5 build 171).

v2.9.8
- Улучшено определение Java
- apktool 2.x теперь использует внешний aapt.
- Обновлен apktool (2.0.0 RC4), jadx (0.5.5 build 166).

v2.9.7
- Добавлен экспертный режим для сборки APK (см readme п. 5.5).
- Добавлено логирование ошибок для пункта [6 Zipalign files].
- Доработана функция декомпиляции приложений на системах, где некорректно задана системная переменная PATH
- Обновлен jadx (0.5.5 build 165).

v2.9.6
- Пункты 04-07 теперь декомпилируют все dex-файлы, а не только classes.dex.
- Обновлен apktool (2.0.0 rc3 от 21.01.2015), smali (2.0.5), jadx (0.5.5 build 164).
- Обновлена Java 8u31 (в standalone-версии BAT).

v2.9.5
- Исправлено игнорирование изменений, внесенных в папки assets и lib при использовании apktool 1.x (дефект появился в BAT289)
- Возвращена совместимость с beta-версиями apktool 2.x

v2.9.4
- Добавлена деодексация файлов *.odex.xz в папке _framework
- Оптимизация кода

v2.9.3
- Добавлена деодексация файлов *.odex.xz (Android 5.0)
- Обновлен jadx (0.5.5 build 163).

v2.9.2
- Добавлена возможность деодексации приложений Android 5.0
- Исправлена некорректная декомпиляция приложений, если в именах файлов их smali-кода содержались недопустимые символы
- Обновлен jadx (0.5.5 build 162).

v2.9.1
- Доработана функция деодексации.
- Обновлен apktool (2.0.0 rc3 от 30.12.2014), smali (2.0.3 от 29.12.2014), jadx (0.5.5 build 157).
- Обновлен aapt.exe для apktool 1.5.2

v2.9
- В логи добавлена информация о версиях используемых компонентов.
- Фреймы при использовании apktool_2.x теперь устанавливаются в папку утилиты.
- Обновлен apktool (2.0.0 rc3 от 26.12.2014), jadx (0.5.5 build 155).

v2.8.9
- Исправлено сохранение версии приложения и версии SDK, измененных через apktool.yml.
- Обновлен apktool (2.0.0 rc2 от 02.11.2014), smali (2.0.3 от 06.11.2014), jd-gui (0.3.7 RC1), jadx (0.5.5 build 142).

v2.8.8
- Возвращено создание резервной копии в папке _backup.
- Standalone-версия Batch ApkTool теперь использует Java 8.
- Обновлен apktool (2.0.0 rc2 от 20.10.2014), jadx (0.5.3 build 131).
- Улучшения и исправления.

v2.8.7
- При копировании файлов в системные папки им теперь выставляются права 644
- Обновлен алгоритм сборки APK через apktool 2.x
- Логи теперь откываются в редакторе, ассоциированном в системе с файлами txt
- Обновлен apktool (2.0.0 rc2 от 05.10.2014), jadx (0.5.3 build 128).

v2.8.6
- Добавлено определение версии Java при запуске утилиты
- Обновлен aapt.exe для apktool 1.5.2
- Обновлен apktool (2.0.0 rc1 от 24.09.2014), jadx (0.5.3 build 126).

v2.8.5
- Немного увеличена скорость деодексации и рекомпиляции (примерно на 10-20%)
- Добавлена опция [87 Don't write out debug info]
- Добавлена возможность выбора ключа для подписи APK, ZIP и JAR файлов
- Обновлен apktool (2.0.0 rc1 от 27.08.2014), smali (2.0.3 от 28.08.2014), jadx (0.5.3 build 120).

v2.8.4
- Добавлена поддержка apk, содержащих несколько dex-файлов
- Обновлен apktool (2.0.0 rc1 от 16.08.2014), jadx (0.5.2).

v2.8.3
- Исправлена ситуация у некоторых пользователей, когда после декомпиляции папка разобранного приложения оказывалась пустой
- Обновлен jadx (0.5.2 build 102).

v2.8.2
- Добавлены операции пакетной установки приложений (в т.ч. на SD-карту) и копирования файлов в устройство
- Запрещен запуск нескольких копий утилиты
- Изменен метод вывода цветного текста (для переводчиков утилиты на русский и другие языки)
- Обновлен jadx (0.5.2 build 96).

v2.8.1
- Добавлена пара проверок при запуске утилиты
- Добавлен пункт [20 info] - информация о версии android и файловой системе
- Обновлен smali (2.0.3 от 22.07.2014), jadx (0.5.2 build 92).

v2.8
- Добавлено копирование (pull) папок /system/app, /system/priv-app и /system/framework из устройства
- Добавлена возможность сохранить полный багрепорт устройства (logs > bugreport)
- Формат окончания строк в файлах логов и багрепорта теперь стандартный для Windows - CR+LF
- Обновлен jadx (0.5.2 build 88)

v2.7.1
- Существенно ускорено конвертирование unicode escapes в UTF-8
- Теперь при разборе через [06 Decompile JARs (only smali)] не используются параметры -l и -s.
- Обновлен jadx (0.5.1 build 82).

v2.7
- Добавлено конвертирование unicode escapes в UTF-8 (smali).
- Добавлены цвета)
- Оптимизирован алгоритм детекта внесенных изменений, увеличена скорость рекомпиляции (до 2-х раз)
- Добавлены smali-baksmali версии 1.4.2.
- Обновлены бинарники aapt, adb и zipalign.
- Обновлен jadx (0.5.1 build 80).
- Исправлена некорректная дата в имени логов и скриншотов, если формат региональных стандартов отличен от русского.

v2.6
- Увеличена скорость рекомпиляции (в зависимости от исходного файла и внесенных изменений - до 3-х раз)
- Изменение логики открытия лога, снова)): два режима - MANUAL и ON.
- Обновлен apktool (2.0.0 rc1 от 18.06.2014), jadx (0.5.1 build 78).

v2.5
- Добавлена опция [86 Keep broken resources] для принудительной декомпиляции поврежденных ресурсов.
- Добавлена запись файлов а папку /system/priv-app.
- Теперь после каждой операции выводится предложение открытия лога.
- Обновлен apktool (2.0.0 rc1 от 25.05.2014), jadx (0.5.1 build 70).

v2.4.1
- Возвращен прежний алгоритм определения изменений в AndroidManifest.xml, без учета apktool.yml.
- Исправлено падение при работе с файлами, содержащими в имени скобки (), а также при вводе некоторых спецсимволов вместо номера пункта меню.
- Обновлен jadx (0.5.1 build 68).

v2.4
- Добавлена возможность выбрать для обработки один файл.
- Обновлен apktool (2.0.0 rc1), jadx (0.5.1 build 63).
- Исправлено сохранение изменений в apktool.yml.
- Мелкие улучшения и исправления.

v2.3
- Добавлена возможность подключения ADB по Wi-Fi.
- Исправлена запись видео командой [17].
- Обновлены бинарники adb и aapt.
- Мелкие улучшения.

v2.2
- Добавлен просмотр исходного Java кода APK, JAR и DEX файлов.
- Добавлена запись видео с экрана через ADB (требуется android 4.4 или выше).
- Изменена логика работы пунктов меню [11], [13], [14] и [15].
- Исправлена ошибка рекомпиляции c использованием apktool 1.x, появившаяся в v2.1.

v2.1
- Добавлена возможность создания и загрузки проектов.
- Пункты рекомпиляции и сборки результирующего APK объединены в один пункт.
- Опция подписи стала глобальной и теперь применяется ко всем выходным APK.
- Опция подписи включена по умолчанию
- Код smali при разборе через smali теперь соответствует коду smali при разборе через apktool.
- Исполняемые файлы программы перенесены в папку bin

v2.0
- Первая) версия


Автор - BurSoft
bursoft-portable.blogspot.com